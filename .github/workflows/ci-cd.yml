name: CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build:
    name: Build & Test (Maven)
    runs-on: ubuntu-latest
    env:
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
      DB_HOST: ${{ secrets.DB_HOST }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      KAFKA_BOOTSTRAP_SERVERS: ${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
      VERBOSE_SSH: ${{ secrets.VERBOSE_SSH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Safety scan for private keys
        run: |
          echo "Scanning repository for possible private key leaks..."
          set +e
          git grep -I --line-number -E 'BEGIN (RSA |OPENSSH |)PRIVATE KEY' || true
          if git grep -I -q -E 'BEGIN (RSA |OPENSSH |)PRIVATE KEY'; then
            echo "Potential private key found in the repository. Do NOT commit private keys. Remove them and add them as GitHub secrets instead." >&2
            git grep -I -n -E 'BEGIN (RSA |OPENSSH |)PRIVATE KEY'
            exit 1
          fi
          set -e

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Decide test mode
        run: |
          echo "Checking for database and Kafka secrets to decide whether to run tests..."
          if [ -n "$SPRING_DATASOURCE_URL" ] || [ -n "$DB_HOST" ] || [ -n "$POSTGRES_DB" ] || [ -n "$KAFKA_BOOTSTRAP_SERVERS" ]; then
            echo "RUN_TESTS=true" >> $GITHUB_ENV
          else
            echo "RUN_TESTS=false" >> $GITHUB_ENV
          fi

      - name: 'Debug - environment presence (non-secret)'
        if: always()
        run: |
          echo "Checking CI env variables presence for debugging..."
          for v in SPRING_DATASOURCE_URL DB_HOST POSTGRES_DB KAFKA_BOOTSTRAP_SERVERS RUN_TESTS SERVER_HOST SERVER_USER SERVER_PORT SERVER_SSH_KEY VERBOSE_SSH; do
            if [ -n "${!v}" ]; then
              echo " - $v: SET"
            else
              echo " - $v: NOT SET"
            fi
          done

      - name: Build and run tests (per module)
        run: |
          set -e
          echo "Detecting modules with pom.xml files..."
          MODULE_DIRS=$(git ls-files '*pom.xml' | xargs -n1 dirname | sort -u)
          echo "Modules found: $MODULE_DIRS"
          for dir in $MODULE_DIRS; do
            # Skip root if present
            if [ "$dir" = "." ]; then
              echo "Skipping root directory (no POM at repo root)"
              continue
            fi
            echo "Building module: $dir"
            if [ "$RUN_TESTS" = "true" ]; then
              echo "RUN_TESTS=true: Running full verify including tests"
              mvn -f "$dir/pom.xml" -B -V -T 1C verify
            else
              echo "RUN_TESTS=false: Skipping tests and running package only"
              mvn -f "$dir/pom.xml" -B -V -T 1C -DskipTests -DskipITs package
            fi
          done

      - name: 'Debug - list built artifacts'
        if: always()
        run: |
          echo "List of jars built (target/*.jar):"
          for d in $(git ls-files '*pom.xml' | xargs -n1 dirname | sort -u); do
            if [ "$d" = "." ]; then continue; fi
            echo " - $d"
            ls -l "$d/target" || true
          done


  deploy-droplet:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check deploy secrets presence
        run: |
          echo "Checking if deployment secrets are present..."
          if [ -z "$SERVER_SSH_KEY" ] || [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USER" ]; then
            echo "Deployment secrets are not all present. Skipping deploy. Set SERVER_SSH_KEY, SERVER_HOST, and SERVER_USER in repository secrets to enable deploy." >&2
            exit 0
          else
            echo "Deployment secrets found. Continuing deploy steps..."
          fi

      - name: Install SSH Key
        if: ${{ env.SERVER_SSH_KEY && env.SERVER_HOST && env.SERVER_USER }}
        run: |
          mkdir -p ~/.ssh
          # Use printf to preserve newlines and avoid CRLF issues
          if [ -z "$SERVER_SSH_KEY" ]; then
            echo "Missing SSH key (SERVER_SSH_KEY) - add it as a secret to this repo"
            exit 1
          fi
          printf '%s\n' "$SERVER_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Validate that the key looks like a private key
          if ! grep -q -E 'BEGIN (RSA |OPENSSH |)PRIVATE KEY' ~/.ssh/id_rsa; then
            echo "The provided SERVER_SSH_KEY does not look like a private key (BEGIN PRIVATE KEY header missing). Please ensure you pasted the full private key that starts with '-----BEGIN' and ends with '-----END'" >&2
            exit 1
          fi

      - name: Add droplet to known_hosts
        if: ${{ env.SERVER_SSH_KEY && env.SERVER_HOST && env.SERVER_USER }}
        run: |
          if [ -n "$SERVER_PORT" ]; then
            ssh-keyscan -p $SERVER_PORT -H $SERVER_HOST >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
          fi

      - name: 'Debug - deploy env presence (non-secret)'
        if: ${{ env.SERVER_SSH_KEY && env.SERVER_HOST && env.SERVER_USER }}
        run: |
          echo "Debugging deploy environment variables (safe):"
          for v in SERVER_HOST SERVER_USER SERVER_PORT SERVER_SSH_KEY VERBOSE_SSH; do
            if [ -n "${!v}" ]; then
              echo " - $v: SET"
            else
              echo " - $v: NOT SET"
            fi
          done

      - name: 'Verbose SSH connectivity test'
        if: ${{ env.VERBOSE_SSH == 'true' }}
        run: |
          echo "Running verbose SSH test (this will output debug info, do not set in PRs unless needed)..."
          SSH_PORT_ARG=""
          if [ -n "$SERVER_PORT" ]; then
            SSH_PORT_ARG="-p $SERVER_PORT"
          fi
          ssh -vvv -i ~/.ssh/id_rsa $SSH_PORT_ARG -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=10 $SERVER_USER@$SERVER_HOST 'echo "SSH OK"; whoami; hostname; id'

      - name: Test SSH connectivity
        if: ${{ env.SERVER_SSH_KEY && env.SERVER_HOST && env.SERVER_USER }}
        run: |
          echo "Testing SSH connectivity to $SERVER_HOST as $SERVER_USER"
          SSH_PORT_ARG=""
          if [ -n "$SERVER_PORT" ]; then
            SSH_PORT_ARG="-p $SERVER_PORT"
            echo "Using non-standard SSH port: $SERVER_PORT"
          fi
          ssh -i ~/.ssh/id_rsa $SSH_PORT_ARG -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=10 $SERVER_USER@$SERVER_HOST \
            'echo "SSH OK"; whoami; hostname; id; docker --version 2>/dev/null || echo "docker not found"; docker-compose --version 2>/dev/null || echo "docker-compose not found"'

      - name: Deploy via SSH (java 17+ with Docker Compose)
        if: ${{ env.SERVER_SSH_KEY && env.SERVER_HOST && env.SERVER_USER }}
        run: |
          SSH_PORT_ARG=""
          if [ -n "$SERVER_PORT" ]; then
            SSH_PORT_ARG="-p $SERVER_PORT"
            echo "Using non-standard SSH port: $SERVER_PORT"
          fi
          ssh -i ~/.ssh/id_rsa $SSH_PORT_ARG -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
            set -e
            cd distrischool-backend/
            git pull origin main
            cd infra/docker/
            docker-compose down
            docker-compose up -d --build
          EOF